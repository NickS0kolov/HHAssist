from langchain_ollama.llms import OllamaLLM
from langchain_core.prompts import ChatPromptTemplate
from dotenv import load_dotenv
import os

BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
dotenv_path = os.path.join(BASE_DIR, ".env")
if os.path.exists(dotenv_path):
    load_dotenv(dotenv_path)

model_name = os.getenv("OLLAMA_MODEL")
model = OllamaLLM(model=model_name, base_url=os.getenv("OLLAMA_BASE_URL"))

# === –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—é–º–µ ===
async def analyze_resume(resume_text: str, job_description: str) -> str:
    prompt = f"""
    –¢—ã ‚Äî –∫–∞—Ä—å–µ—Ä–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç –æ—Ç–≤–µ—Ç—ã –¥–ª—è Telegram.
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ü–µ–Ω–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–µ–∑—é–º–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ –≤—ã–¥–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–π, –∫–æ—Ä–æ—Ç–∫–∏–π –∏ –∫—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç.

    –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è –µ–≥–æ, —á—Ç–æ–±—ã —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—ã–≥–ª—è–¥–µ–ª–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –≤ Telegram):

    üìã –°–æ–≤–ø–∞–¥–µ–Ω–∏—è:
    (–∫—Ä–∞—Ç–∫–æ, 2-3 –ø—É–Ω–∫—Ç–∞)

    ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞–µ—Ç:
    (–∫—Ä–∞—Ç–∫–æ, 2-3 –ø—É–Ω–∫—Ç–∞)

    üéØ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞: XX%

    üí° –°–æ–≤–µ—Ç—ã:
    (3‚Äì4 —á—ë—Ç–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ –≤–∏–¥–µ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞)

    ‚úâÔ∏è –°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ:
    (2-3 –∫–æ—Ä–æ—Ç–∫–∏—Ö –∞–±–∑–∞—Ü–∞, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ)

    –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—Ü—ã –∏ –¥–ª–∏–Ω–Ω—ã–µ –∞–±–∑–∞—Ü—ã. –ù–µ –ø—Ä–µ–≤—ã—à–∞–π 1000 —Å–∏–º–≤–æ–ª–æ–≤. –ù–µ –æ–±–æ—Ä–∞—á–∏–≤–∞–π —Ç–µ–∫—Å—Ç –≤ HTML-—Ç–µ–≥–∏ –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown.
    –ù–µ –æ–±–æ—Ä–∞—á–∏–≤–∞–π —Ç–µ–∫—Å—Ç –≤ –∑–Ω–∞—á–∫–∏ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ * *.

    –†–µ–∑—é–º–µ: {resume_text}
    –í–∞–∫–∞–Ω—Å–∏—è: {job_description}

    –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞:
    1. –ù–µ –ø–æ–¥–±–∏—Ä–∞–π –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ –Ω–µ –ø—Ä–∏—Å—ã–ª–∞–π —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∞–π—Ç—ã, –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ —Ä–µ—Å—É—Ä—Å—ã.  
    2. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã.  
    3. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∞–≤—ã–∫–∏ –∏–ª–∏ –æ–ø—ã—Ç, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –≤ —Ä–µ–∑—é–º–µ.  
    4. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ ‚Äî –ø—Ä—è–º–æ —É–∫–∞–∂–∏ —ç—Ç–æ.  
    5. –ï—Å–ª–∏ –≤ —Ä–µ–∑—é–º–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —ç—Ç–æ –∏–º—è.  
    6. –ï—Å–ª–∏ –∏–º—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –µ–≥–æ –≤–æ–æ–±—â–µ. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç–æ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!" –±–µ–∑ –∏–º–µ–Ω–∏.  
    7. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–º–µ–Ω–∞, —Ñ–∞–º–∏–ª–∏–∏, –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ.
    8. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ (–¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤) –∏ —Å—Ç—Ä–æ–≥–æ –ø–æ –ø—É–Ω–∫—Ç–∞–º –Ω–∏–∂–µ.

    –û—Ç–≤–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π —Ç–∞–∫:
    1. –°–æ–≤–ø–∞–¥–µ–Ω–∏—è
    2. –ù–µ–¥–æ—Å—Ç–∞–µ—Ç
    3. –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—Ö–∞ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
    4. –°–æ–≤–µ—Ç—ã
    5. –°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ –¥–ª—è –æ—Ç–∫–ª–∏–∫–∞ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é
    """


    prompt = ChatPromptTemplate.from_template(prompt)
    chain = prompt | model
    result = await chain.ainvoke({
        "resume_text": resume_text,
        "job_description": job_description
    })
    return result

# === –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ ===
async def analyze_message(resume_text: str, job_description: str, question: str) -> str:
    prompt = '''
    –¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–æ–∏—Å–∫—É —Ä–∞–±–æ—Ç—ã. 
    –¢–µ–±–µ –ø–∏—à–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç, –∏—â—É—â–∏–π —Ä–∞–±–æ—Ç—É. 
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç—É –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ —Ä–µ–∑—é–º–µ –∏ –≤–∞–∫–∞–Ω—Å–∏–∏, 
    –¥–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —É–ª—É—á—à–µ–Ω–∏—é, –æ—Ü–µ–Ω–∏–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞–≤—ã–∫–æ–≤, 
    –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ, –Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

    –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è –µ–≥–æ, —á—Ç–æ–±—ã —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—ã–≥–ª—è–¥–µ–ª–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –≤ Telegram):
    –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—Ü—ã –∏ –¥–ª–∏–Ω–Ω—ã–µ –∞–±–∑–∞—Ü—ã. –ù–µ –ø—Ä–µ–≤—ã—à–∞–π 1250 —Å–∏–º–≤–æ–ª–æ–≤. –ù–µ –æ–±–æ—Ä–∞—á–∏–≤–∞–π —Ç–µ–∫—Å—Ç –≤ HTML-—Ç–µ–≥–∏ –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown.
    –ù–µ –æ–±–æ—Ä–∞—á–∏–≤–∞–π —Ç–µ–∫—Å—Ç –≤ –∑–Ω–∞—á–∫–∏ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ * *.

    –†–µ–∑—é–º–µ:
    {resume_text}

    –í–∞–∫–∞–Ω—Å–∏—è:
    {job_description}

    –í–æ–ø—Ä–æ—Å:
    {question}

    –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞:
    1. –ù–µ –ø–æ–¥–±–∏—Ä–∞–π –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ –Ω–µ –ø—Ä–∏—Å—ã–ª–∞–π —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∞–π—Ç—ã, –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ —Ä–µ—Å—É—Ä—Å—ã.  
    2. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã.  
    3. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∞–≤—ã–∫–∏ –∏–ª–∏ –æ–ø—ã—Ç, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –≤ —Ä–µ–∑—é–º–µ.  
    4. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ ‚Äî –ø—Ä—è–º–æ —É–∫–∞–∂–∏ —ç—Ç–æ.  
    5. –ï—Å–ª–∏ –≤ —Ä–µ–∑—é–º–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —ç—Ç–æ –∏–º—è.  
    6. –ï—Å–ª–∏ –∏–º—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –µ–≥–æ –≤–æ–æ–±—â–µ. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç–æ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!" –±–µ–∑ –∏–º–µ–Ω–∏.  
    7. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–º–µ–Ω–∞, —Ñ–∞–º–∏–ª–∏–∏, –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ.
    8. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ (–¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤) –∏ —Å—Ç—Ä–æ–≥–æ –ø–æ –ø—É–Ω–∫—Ç–∞–º –Ω–∏–∂–µ.

    –¢–µ–ø–µ—Ä—å –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.
    '''

    prompt = ChatPromptTemplate.from_template(prompt)
    chain = prompt | model
    result = await chain.ainvoke({
        "resume_text": resume_text,
        "job_description": job_description,
        "question": question
    })
    return result